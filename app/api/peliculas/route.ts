import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '../../lib/supabaseServer';
import { loadUserVIPData, isVIPActive } from '../../lib/vipUtils';

// Interface para os dados de pel√≠culas
interface PeliculaData {
  id?: number;
  modelo: string;
  compatibilidade: string;
  is_premium?: boolean;
}

/**
 * üéØ Fun√ß√£o para sele√ß√£o estrat√©gica por linhas de produtos para usu√°rios n√£o-VIP
 * Distribui 49 modelos baseado em linhas espec√≠ficas e populares
 */
function selectStrategicProductLines(allData: PeliculaData[]): PeliculaData[] {
  const selectedModels: PeliculaData[] = [];
  
  // Samsung (20 modelos) - Linhas espec√≠ficas
  const samsungLines = [
    { pattern: ['a0'], limit: 3, name: 'Linha A0x' },
    { pattern: ['a1'], limit: 5, name: 'Linha A1x' },
    { pattern: ['a2'], limit: 4, name: 'Linha A2x' },
    { pattern: ['a3'], limit: 3, name: 'Linha A3x' },
    { pattern: ['a5'], limit: 3, name: 'Linha A5x' },
    { pattern: ['m1', 'm2', 'm3', 'm4'], limit: 2, name: 'Linha M' }
  ];
  
  samsungLines.forEach(line => {
    const lineModels = allData.filter(item => {
      const modelo = item.modelo.toLowerCase();
      return (modelo.includes('samsung') || modelo.includes('galaxy') || modelo.includes('sm-')) &&
             line.pattern.some(pattern => modelo.includes(pattern));
    });
    selectedModels.push(...lineModels.slice(0, line.limit));
    console.log(`üì± Samsung ${line.name}: ${Math.min(lineModels.length, line.limit)} modelos selecionados`);
  });
  
  // Motorola (13 modelos) - Linhas Moto E e Moto G
  const motorolaModels = allData.filter(item => {
    const modelo = item.modelo.toLowerCase();
    return (modelo.includes('moto e') || modelo.includes('moto g')) && 
           (modelo.includes('moto') || modelo.includes('motorola'));
  });
  selectedModels.push(...motorolaModels.slice(0, 13));
  console.log(`üì± Motorola (Moto E/G): ${Math.min(motorolaModels.length, 13)} modelos selecionados`);
  
  // Xiaomi (7 modelos) - Linhas Redmi Note e Redmi
  const xiaomiModels = allData.filter(item => {
    const modelo = item.modelo.toLowerCase();
    return (modelo.includes('redmi note') || modelo.includes('redmi')) &&
           (modelo.includes('xiaomi') || modelo.includes('redmi'));
  });
  selectedModels.push(...xiaomiModels.slice(0, 7));
  console.log(`üì± Xiaomi (Redmi): ${Math.min(xiaomiModels.length, 7)} modelos selecionados`);
  
  // iPhone (5 modelos) - Modelos espec√≠ficos
  const iphoneTargets = ['iphone 7', 'iphone 8', 'iphone x', 'iphone 11', 'iphone 12'];
  iphoneTargets.forEach(target => {
    const iphoneModel = allData.find(item => 
      item.modelo.toLowerCase().includes(target)
    );
    if (iphoneModel) {
      selectedModels.push(iphoneModel);
    }
  });
  console.log(`üì± iPhone (espec√≠ficos): ${selectedModels.filter(item => 
    item.modelo.toLowerCase().includes('iphone')).length} modelos selecionados`);
  
  // LG (4 modelos) - Linha K
  const lgModels = allData.filter(item => {
    const modelo = item.modelo.toLowerCase();
    return modelo.includes('lg') && modelo.includes('k');
  });
  selectedModels.push(...lgModels.slice(0, 4));
  console.log(`üì± LG (Linha K): ${Math.min(lgModels.length, 4)} modelos selecionados`);
  
  // Log final da distribui√ß√£o estrat√©gica
  const finalDistribution = {
    samsung: selectedModels.filter(item => {
      const modelo = item.modelo.toLowerCase();
      return modelo.includes('samsung') || modelo.includes('galaxy') || modelo.includes('sm-');
    }).length,
    motorola: selectedModels.filter(item => {
      const modelo = item.modelo.toLowerCase();
      return modelo.includes('moto') || modelo.includes('motorola');
    }).length,
    xiaomi: selectedModels.filter(item => {
      const modelo = item.modelo.toLowerCase();
      return modelo.includes('xiaomi') || modelo.includes('redmi');
    }).length,
    iphone: selectedModels.filter(item => 
      item.modelo.toLowerCase().includes('iphone')
    ).length,
    lg: selectedModels.filter(item => 
      item.modelo.toLowerCase().includes('lg')
    ).length,
    total: selectedModels.length
  };
  
  console.log('üéØ Distribui√ß√£o final estrat√©gica para n√£o-VIP:', finalDistribution);
  
  return selectedModels;
}

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const userEmail = searchParams.get('email');
    const searchTerm = searchParams.get('search') || '';
    
    console.log('üîç API Pel√≠culas - Email:', userEmail, 'Search:', searchTerm);
    
    // Criar cliente Supabase administrativo
    const supabase = createServerSupabaseClient();

    // Verificar se o usu√°rio √© VIP
    let isUserVIP = false;
    if (userEmail) {
      try {
        console.log('üîç Verificando status VIP para:', userEmail);
        
        // M√©todo 1: Verificar na tabela usuarios_vip
        const vipData = await loadUserVIPData(userEmail);
        if (vipData) {
          isUserVIP = isVIPActive({ email: userEmail, vip_data: vipData });
          console.log('üëë VIP encontrado na tabela usuarios_vip:', isUserVIP);
        } else {
          // M√©todo 2: Verificar na tabela profiles
          console.log('üîÑ Verificando VIP na tabela profiles...');
          const { data: profileData, error: profileError } = await supabase
            .from('profiles')
            .select('is_vip, vip_expires_at')
            .eq('email', userEmail)
            .single();
          
          if (!profileError && profileData) {
            if (profileData.is_vip && profileData.vip_expires_at) {
              const expiresAt = new Date(profileData.vip_expires_at);
              isUserVIP = expiresAt > new Date();
              console.log('üëë VIP encontrado na tabela profiles:', isUserVIP, 'expira em:', expiresAt);
            } else if (profileData.is_vip && !profileData.vip_expires_at) {
              // VIP sem data de expira√ß√£o (VIP permanente)
              isUserVIP = true;
              console.log('üëë VIP permanente encontrado na tabela profiles');
            }
          } else {
            console.log('‚ùå Usu√°rio n√£o encontrado na tabela profiles:', profileError?.message);
          }
        }
        
        console.log('üéØ Status VIP final:', isUserVIP);
      } catch (error) {
        console.error('‚ùå Erro ao verificar VIP:', error);
      }
    }

    // üîí CORRE√á√ÉO DE SEGURAN√áA: Buscar dados aplicando limita√ß√£o VIP no servidor
    let peliculasData: PeliculaData[] = [];
    
    try {
      // üîí SEGURAN√áA: Tratamento diferenciado para VIP vs n√£o-VIP
      if (!isUserVIP) {
        // Para n√£o-VIP: buscar todos os dados e aplicar diversifica√ß√£o
        const { data: allData, error: allError } = await supabase
          .from('peliculas_3d')
          .select('*');
        
        if (!allError && allData) {
          // Aplicar sele√ß√£o estrat√©gica por linhas de produtos
          peliculasData = selectStrategicProductLines(allData);
          console.log(`üîí Usu√°rio n√£o-VIP: aplicada sele√ß√£o estrat√©gica por linhas, ${peliculasData.length} registros selecionados`);
          
          // Se h√° termo de busca, filtrar nos dados j√° diversificados
          if (searchTerm) {
            peliculasData = peliculasData.filter((item: PeliculaData) => 
              item.modelo.toLowerCase().includes(searchTerm.toLowerCase()) ||
              item.compatibilidade.toLowerCase().includes(searchTerm.toLowerCase())
            );
          }
        } else {
          console.log('‚ö†Ô∏è Erro ao buscar todos os dados para sele√ß√£o estrat√©gica, usando fallback JSON');
          throw allError;
        }
      } else {
        // Para VIP: busca normal com filtros aplicados diretamente
        let query = supabase.from('peliculas_3d').select('*');
        
        // Aplicar filtro de busca se fornecido
        if (searchTerm) {
          query = query.ilike('modelo', `%${searchTerm}%`);
        }
        
        const { data, error } = await query;

        if (error) {
          console.log('‚ö†Ô∏è Tabela peliculas_3d n√£o existe, usando fallback JSON');
          throw error;
        }

        peliculasData = data || [];
        console.log(`üìä Usu√°rio VIP: encontrados ${peliculasData.length} registros no Supabase`);
      }
      
    } catch (supabaseError) {
      // Fallback: usar dados do JSON com limita√ß√£o segura
      console.log('üìÑ Usando dados do arquivo JSON como fallback');
      const dadosPeliculas = require('../../../data/dadosPeliculas.json');
      
      // üîí SEGURAN√áA: Aplicar limita√ß√£o ANTES da busca com sele√ß√£o estrat√©gica por linhas
      let limitedData = dadosPeliculas;
      if (!isUserVIP) {
        limitedData = selectStrategicProductLines(dadosPeliculas);
        console.log(`üîí Usu√°rio n√£o-VIP: limitando dataset para ${limitedData.length} registros com sele√ß√£o estrat√©gica por linhas`);
      }
      
      // Filtrar por termo de busca APENAS nos dados j√° limitados
      peliculasData = limitedData.filter((item: PeliculaData) => 
        searchTerm === '' || 
        item.modelo.toLowerCase().includes(searchTerm.toLowerCase()) ||
        item.compatibilidade.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }

    // Log final
    if (isUserVIP) {
      console.log(`üéØ Usu√°rio VIP: acesso a todos os dados dispon√≠veis (${peliculasData.length} registros)`);
    } else {
      console.log(`üîí Usu√°rio n√£o-VIP: acesso limitado a ${peliculasData.length} registros`);
    }

    return NextResponse.json({
      success: true,
      data: peliculasData,
      isVIP: isUserVIP,
      totalShown: peliculasData.length,
      message: isUserVIP 
        ? 'Acesso VIP: dados completos dispon√≠veis' 
        : 'Acesso limitado: apenas 10% dos dados. Assine o VIP para acesso completo!'
    });

  } catch (error) {
    console.error('‚ùå Erro na API pel√≠culas:', error);
    return NextResponse.json({
      success: false,
      error: 'Erro interno do servidor',
      data: []
    }, { status: 500 });
  }
}

// Fun√ß√£o para migrar dados do JSON para Supabase (executar uma vez)
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    
    // Verificar se √© uma requisi√ß√£o de migra√ß√£o autorizada
    if (body.action !== 'migrate' || body.adminKey !== 'migrate_peliculas_2024') {
      return NextResponse.json({ 
        success: false, 
        error: 'A√ß√£o n√£o autorizada' 
      }, { status: 401 });
    }

    console.log('üöÄ Iniciando migra√ß√£o dos dados de pel√≠culas...');
    
    // Criar cliente Supabase administrativo
    const supabase = createServerSupabaseClient();
    
    // Carregar dados do JSON
    const dadosPeliculas = require('../../../data/dadosPeliculas.json');
    
    // Preparar dados para inser√ß√£o no Supabase
    const peliculasForInsert = dadosPeliculas.map((item: PeliculaData, index: number) => ({
      modelo: item.modelo,
      compatibilidade: item.compatibilidade,
      is_premium: index >= Math.ceil(dadosPeliculas.length * 0.1) // Marcar 90% como premium
    }));

    // Inserir no Supabase em lotes
    const batchSize = 100;
    let totalInserted = 0;
    
    for (let i = 0; i < peliculasForInsert.length; i += batchSize) {
      const batch = peliculasForInsert.slice(i, i + batchSize);
      
      const { data, error } = await supabase
        .from('peliculas_3d')
        .insert(batch);
      
      if (error) {
        console.error('‚ùå Erro no lote:', error);
        throw error;
      }
      
      totalInserted += batch.length;
      console.log(`‚úÖ Inseridos ${batch.length} registros (total: ${totalInserted})`);
    }

    console.log('üéâ Migra√ß√£o conclu√≠da com sucesso!');
    
    return NextResponse.json({
      success: true,
      message: `Migra√ß√£o conclu√≠da: ${totalInserted} registros inseridos`,
      totalInserted
    });

  } catch (error) {
    console.error('‚ùå Erro na migra√ß√£o:', error);
    return NextResponse.json({
      success: false,
      error: 'Erro na migra√ß√£o: ' + (error as Error).message
    }, { status: 500 });
  }
}